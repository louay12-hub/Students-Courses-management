<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Student & Course Manager</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #f8f9fa; }
    .container { margin-top: 30px; }
    .card { margin-bottom: 20px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    .table td, .table th { vertical-align: middle; }
    .badge { margin: 2px; }
    .course-badge { font-size: 0.8rem; }
    .btn-sm { font-size: 0.8rem; }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="text-center mb-4 fw-bold">üéì Student & Course Management Dashboard</h1>

    <div class="row">
      <!-- COURSES -->
      <div class="col-md-5">
        <div class="card border-primary">
          <div class="card-header bg-primary text-white fw-semibold">Courses</div>
          <div class="card-body">
            <form id="courseForm" class="row g-2">
              <div class="col-md-5"><input class="form-control" id="courseTitle" placeholder="Course Title" required></div>
              <div class="col-md-4"><input class="form-control" id="courseCode" placeholder="Code" required></div>
              <div class="col-md-3"><button class="btn btn-success w-100" type="submit">Add</button></div>
            </form>

            <table class="table table-hover table-striped mt-3" id="coursesTable">
              <thead class="table-primary"><tr><th>Title</th><th>Code</th><th>Actions</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- STUDENTS -->
      <div class="col-md-7">
        <div class="card border-success">
          <div class="card-header bg-success text-white fw-semibold">Students</div>
          <div class="card-body">
            <form id="studentForm" class="row g-2">
              <div class="col-md-4"><input class="form-control" id="studentName" placeholder="Student Name" required></div>
              <div class="col-md-5"><input class="form-control" id="studentEmail" placeholder="Email"></div>
              <div class="col-md-3"><button class="btn btn-warning w-100" type="submit">Add</button></div>
            </form>

            <table class="table table-hover table-striped mt-3" id="studentsTable">
              <thead class="table-success">
                <tr>
                  <th>Name</th>
                  <th>Email</th>
                  <th>Registered Courses</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== Modals ===== -->
  <!-- Edit Course Modal -->
  <div class="modal fade" id="editCourseModal" tabindex="-1" aria-labelledby="editCourseModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="editCourseForm">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title" id="editCourseModalLabel">Edit Course</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="editCourseId">
            <div class="mb-3">
              <label class="form-label">Course Title</label>
              <input type="text" id="editCourseTitle" class="form-control" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Course Code</label>
              <input type="text" id="editCourseCode" class="form-control" required>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Save Changes</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Edit Student Modal -->
  <div class="modal fade" id="editStudentModal" tabindex="-1" aria-labelledby="editStudentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="editStudentForm">
          <div class="modal-header bg-success text-white">
            <h5 class="modal-title" id="editStudentModalLabel">Edit Student</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="editStudentId">
            <div class="mb-3">
              <label class="form-label">Name</label>
              <input type="text" id="editStudentName" class="form-control" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Email</label>
              <input type="email" id="editStudentEmail" class="form-control">
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-success">Save Changes</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const API = 'https://students-courses-management-9xk4.onrender.com';
    const coursesTable = document.querySelector('#coursesTable tbody');
    const studentsTable = document.querySelector('#studentsTable tbody');
    let courses = [];
    let students = [];

    const editCourseModal = new bootstrap.Modal(document.getElementById('editCourseModal'));
    const editStudentModal = new bootstrap.Modal(document.getElementById('editStudentModal'));

    async function fetchData() {
      const [cRes, sRes] = await Promise.all([
        fetch(API + '/courses'),
        fetch(API + '/students')
      ]);
      courses = await cRes.json();
      students = await sRes.json();
      renderCourses();
      renderStudents();
    }

    // ===== Render Courses =====
    function renderCourses() {
      coursesTable.innerHTML = '';
      courses.forEach(c => {
        coursesTable.innerHTML += `
          <tr>
            <td>${c.title}</td>
            <td>${c.code}</td>
            <td>
              <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-primary" onclick="openEditCourse('${c._id}')">‚úèÔ∏è Edit</button>
                <button class="btn btn-outline-danger" onclick="deleteCourse('${c._id}')">üóëÔ∏è Delete</button>
              </div>
            </td>
          </tr>`;
      });
    }

    // ===== Render Students =====
    function renderStudents() {
      studentsTable.innerHTML = '';
      students.forEach(s => {
        const registered = s.registeredCourses?.length
          ? s.registeredCourses.map(r =>
              `<span class="badge bg-info text-dark course-badge">${r.title} (${r.code})</span>`
            ).join(' ')
          : `<span class="text-muted">No courses</span>`;

        const courseOptions = courses.map(c =>
          `<option value="${c._id}">${c.title} (${c.code})</option>`
        ).join('');

        studentsTable.innerHTML += `
          <tr>
            <td><strong>${s.name}</strong></td>
            <td>${s.email || ''}</td>
            <td>${registered}</td>
            <td>
              <div class="d-flex flex-column gap-1">
                <select class="form-select form-select-sm" id="courseSelect-${s._id}">
                  <option value="">Select a course</option>${courseOptions}
                </select>
                <div class="btn-group btn-group-sm">
                  <button class="btn btn-outline-primary" onclick="registerCourse('${s._id}')">Register</button>
                  <button class="btn btn-outline-danger" onclick="unregisterCourse('${s._id}')">Unregister</button>
                </div>
                <div class="btn-group btn-group-sm">
                  <button class="btn btn-outline-success" onclick="openEditStudent('${s._id}')">‚úèÔ∏è Edit</button>
                  <button class="btn btn-outline-dark" onclick="deleteStudent('${s._id}')">üóëÔ∏è Delete</button>
                </div>
              </div>
            </td>
          </tr>`;
      });
    }

    // ===== Add New Course / Student =====
    document.getElementById('courseForm').addEventListener('submit', async e => {
      e.preventDefault();
      const title = courseTitle.value.trim();
      const code = courseCode.value.trim();
      const res = await fetch(API + '/courses', {
        method: 'POST', headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ title, code })
      });
      if (res.ok) { fetchData(); courseTitle.value=''; courseCode.value=''; }
      else alert((await res.json()).error);
    });

    document.getElementById('studentForm').addEventListener('submit', async e => {
      e.preventDefault();
      const name = studentName.value.trim();
      const email = studentEmail.value.trim();
      const res = await fetch(API + '/students', {
        method: 'POST', headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ name, email })
      });
      if (res.ok) { fetchData(); studentName.value=''; studentEmail.value=''; }
      else alert((await res.json()).error);
    });

    // ===== Delete =====
    async function deleteCourse(id) {
      if (!confirm('Are you sure you want to delete this course?')) return;
      const res = await fetch(API + '/courses/' + id, { method: 'DELETE' });
      if (res.ok) fetchData(); else alert('Error deleting course');
    }

    async function deleteStudent(id) {
      if (!confirm('Are you sure you want to delete this student?')) return;
      const res = await fetch(API + '/students/' + id, { method: 'DELETE' });
      if (res.ok) fetchData(); else alert('Error deleting student');
    }

    // ===== Register / Unregister =====
    async function registerCourse(studentId) {
      const select = document.getElementById('courseSelect-' + studentId);
      const courseId = select.value;
      if (!courseId) return alert('Please select a course first!');
      const res = await fetch(API + `/students/${studentId}/register`, {
        method: 'POST', headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ courseId })
      });
      if (res.ok) fetchData(); else alert((await res.json()).error);
    }

    async function unregisterCourse(studentId) {
      const select = document.getElementById('courseSelect-' + studentId);
      const courseId = select.value;
      if (!courseId) return alert('Please select a course first!');
      const res = await fetch(API + `/students/${studentId}/unregister`, {
        method: 'POST', headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ courseId })
      });
      if (res.ok) fetchData(); else alert((await res.json()).error);
    }

    // ===== Edit Course =====
    function openEditCourse(id) {
      const course = courses.find(c => c._id === id);
      if (!course) return;
      editCourseId.value = id;
      editCourseTitle.value = course.title;
      editCourseCode.value = course.code;
      editCourseModal.show();
    }

    document.getElementById('editCourseForm').addEventListener('submit', async e => {
      e.preventDefault();
      const id = editCourseId.value;
      const title = editCourseTitle.value.trim();
      const code = editCourseCode.value.trim();
      const res = await fetch(API + '/courses/' + id, {
        method: 'PUT', headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ title, code })
      });
      if (res.ok) { editCourseModal.hide(); fetchData(); }
      else alert('Error updating course');
    });

    // ===== Edit Student =====
    function openEditStudent(id) {
      const student = students.find(s => s._id === id);
      if (!student) return;
      editStudentId.value = id;
      editStudentName.value = student.name;
      editStudentEmail.value = student.email || '';
      editStudentModal.show();
    }

    document.getElementById('editStudentForm').addEventListener('submit', async e => {
      e.preventDefault();
      const id = editStudentId.value;
      const name = editStudentName.value.trim();
      const email = editStudentEmail.value.trim();
      const res = await fetch(API + '/students/' + id, {
        method: 'PUT', headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ name, email })
      });
      if (res.ok) { editStudentModal.hide(); fetchData(); }
      else alert('Error updating student');
    });

    fetchData();
  </script>
</body>
</html>
